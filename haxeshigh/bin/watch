#! /bin/bash

logDir="/home/cji/portless/lua/awesome-config/haxeshigh/logs/"
logFile="$logDir/build.log"

while true; do
    find . ! -iname '.*.hx' -iname '*.hx' | xargs inotifywait -e modify

    (>$logFile 2>&1 make build)
    if [ $? != 0  ]; then
        noti -t 'Compilation failed!!' -m "$(cat $logFile)"
        continue
    else
        echo ok # noti -t 'Compilation ok!' -m "$(wc -l build/*)"
    fi

    (>>$logFile 2>&1 make clean)
    if [ $? != 0 ]; then
        noti -t "Cleanup failed!" -m "$(cat $logDir/std.log)"
    else
        echo ok # noti -t "Cleanup ok!" -m "$(cat $logDir/std.log)"
    fi

    (>>$logFile 2>&1 make load)
    if [ $? != 0 ]; then
        noti -t "Loading failed!" -m "$(cat $logDir/std.log)"
    else
        echo ok # noti -t "Loaded ok!" -m "$(cat $logDir/std.log)"
    fi
    echo 'Cleanup&loading completed!'
done
